#
# MapServer Mapfile
#
# Test requests:
#
# WMS GetCapabilities:
# /mapserv?service=wms&version=1.1.1&request=getcapabilities
#
# WMS GetMap:
# /mapserv?service=wms&version=1.1.1&request=getmap&bbox=-180,-90,180,90&layers=countries&width=600&height=400&srs=EPSG:4326&format=image/png
#
# WMS GetFeatureInfo:
# /mapserv?service=wms&version=1.1.1&request=getfeatureinfo&bbox=-180,-90,180,90&layers=countries&query_layers=countries&width=600&height=400&srs=EPSG:4326&format=image/png&x=180&y=90&info_format=application/vnd.ogc.gml
#

MAP
    NAME "geoportal"

    EXTENT -1016446 5017723 1592763 6676365
    UNITS METERS

    # RESOLUTION and DEFRESOLUTION default to 72. If you
    # change RESOLUTION to some other value, also change
    # DEFRESOLUTION. See
    # http://mapserver.org/development/rfc/ms-rfc-55.html
    RESOLUTION 72 ## Also set in Openlayers for especially legends
    DEFRESOLUTION 72

    # MAXSIZE shouldn't be less than 5000 for MF print on A3
    MAXSIZE 5000

    SHAPEPATH '/var/sig/c2cgeoportal'

    IMAGECOLOR 255 255 255
    STATUS ON

    FONTSET "fonts.conf"
    SYMBOLSET "symbols.sym"

    #CONFIG "MS_ERRORFILE" "ms_error.log"
    #DEBUG 5

    OUTPUTFORMAT
        NAME jpeg
        DRIVER "AGG/JPEG"
        MIMETYPE "image/jpeg"
        IMAGEMODE RGB
        EXTENSION "jpeg"
        FORMATOPTION "QUALITY=75,PROGRESSIVE=TRUE"
    END

    OUTPUTFORMAT
        NAME png
        DRIVER AGG/PNG
        MIMETYPE "image/png"
        IMAGEMODE RGBA
        EXTENSION "png"
        FORMATOPTION "INTERLACE=OFF"
        FORMATOPTION "QUANTIZE_DITHER=OFF"
        FORMATOPTION "QUANTIZE_FORCE=ON"
        FORMATOPTION "QUANTIZE_COLORS=256"
    END

    PROJECTION
        "init=epsg:3857"
    END

    WEB
        METADATA
            "wms_title" "Flux de démo du c2cgeoportal"
            "wms_abstract" "Des exemples de couches à partir de données OpenData de différentes villes françaises et suisse."
            "wms_onlineresource" "http://${vars:host}/${vars:instanceid}/wsgi/mapserv_proxy"
            "wms_srs" "epsg:3857"
            "wms_encoding" "UTF-8"
            "wms_enable_request" "*"
            "wfs_enable_request" "*"
            "wfs_encoding" "UTF-8"
        END
    END

    LEGEND
        LABEL
            ENCODING "UTF-8"
            TYPE TRUETYPE
            FONT "Arial"
            SIZE 9
        END
    END

    INCLUDE "administration.map"
    INCLUDE "equipement.map"
    INCLUDE "paysage.map"
    INCLUDE "environnement.map"
    INCLUDE "patrimoine.map"


    # raster layer (with a tile index)
   # LAYER
   #     NAME 'topo'
   #     GROUP 'plan'
   #     TYPE RASTER
   #     STATUS ON
   #     PROCESSING "RESAMPLE=AVERAGE"
   #     TILEINDEX "raster/topo"
   #     TILEITEM "LOCATION"
   #     MINSCALEDENOM 25000
   # END

  LAYER 
    NAME 'MTP_rue'
    GROUP 'plan'
    TYPE LINE
    STATUS ON
    EXTENT 420107 5398192 442381 5412352
    CONNECTIONTYPE postgis
    PROCESSING "CLOSE_CONNECTION=DEFER" # For performance
    CONNECTION "${mapserver_connection}"
    DATA "geom FROM (SELECT geo.geom as geom, len, gid, lib_off FROM geodata.mtp_rue_simple AS geo) AS foo USING UNIQUE gid USING srid=3857"

    PROJECTION
      "init=epsg:3857"
    END
    LABELITEM "lib_off"
    LABELMAXSCALEDENOM 7000
    CLASS
       EXPRESSION ([len] > 100)
       STYLE
       END
       LABEL
         COLOR  50 50 50
         OUTLINECOLOR 255 255 255
         FONT "arial"
         TYPE truetype
         SIZE 7
         ANGLE follow
         POSITION AUTO
         PARTIALS FALSE
         PRIORITY 10
         MINDISTANCE 20
         MINFEATURESIZE 20
         REPEATDISTANCE 200
       END
    END
    METADATA
      "wms_title" "Rue de Montpellier"
      "wms_abstract" "Rue de Montpellier."
      "wms_group_title" "plan"
      "wms_srs" "epsg:3857"
      "gml_include_items" "lib_off"
    END
  END

  LAYER
    NAME 'MTP_rue2'
    GROUP 'plan'
    TYPE LINE
    STATUS ON
    EXTENT 420107 5398192 442381 5412352
    CONNECTIONTYPE postgis
    PROCESSING "CLOSE_CONNECTION=DEFER" # For performance
    CONNECTION "${mapserver_connection}"
    DATA "geom FROM (SELECT geo.geom as geom, len, gid, lib_off FROM geodata.mtp_rue_simple AS geo) AS foo USING UNIQUE gid USING srid=900913"

    PROJECTION
      "init=epsg:3857"
    END
    LABELITEM "lib_off"
    LABELMAXSCALEDENOM 3000
    CLASS
       EXPRESSION ([len] < 101)
       STYLE
       END
       LABEL
         COLOR  50 50 50
         OUTLINECOLOR 255 255 255
         FONT "arial"
         TYPE truetype
         SIZE 7
         ANGLE follow
         MINDISTANCE 20
         MINFEATURESIZE 20
         REPEATDISTANCE 200
         POSITION AUTO
         PARTIALS FALSE
         PRIORITY 10
       END
    END
    METADATA
      "wms_title" "Rue de Montpellier"
      "wms_abstract" "Rue de Montpellier."
      "wms_group_title" "plan"
      "wms_srs" "epsg:3857"
      "gml_include_items" "lib_off"
    END
  END

  LAYER
   NAME 'MTP_adresse'
   GROUP 'plan'
   TYPE POINT
   STATUS ON
   EXTENT 420107 5398192 442381 5412352
    CONNECTIONTYPE postgis
    PROCESSING "CLOSE_CONNECTION=DEFER" # For performance
    CONNECTION "${mapserver_connection}"
    DATA "geom FROM (SELECT geo.geom as geom, gid, num_voi FROM geodata.adresse AS geo) AS foo USING UNIQUE gid USING srid=900913"

    PROJECTION
      "init=epsg:3857"
    END
    LABELITEM "num_voi"
    LABELMAXSCALEDENOM 2000
    CLASS
       STYLE
       END
       LABEL
         COLOR  150 150 150
         OUTLINECOLOR 255 255 255
         FONT "arial"
         TYPE truetype
         SIZE 6
         POSITION AUTO
         PARTIALS FALSE
       END
    END
    METADATA
      "wms_title" "Numéro adresse"
      "wms_abstract" "Numéro d'adresse de Montpellier."
      "wms_group_title" "plan"
      "wms_srs" "epsg:3857"
      "gml_include_items" "num_voi"
    END
  END

  LAYER
    NAME 'MTP_planville'
    GROUP 'plan'
    TYPE POLYGON
    STATUS ON
    #DEBUG 5
    TEMPLATE fooOnlyForWMSGetFeatureInfo # For GetFeatureInfo
    EXTENT 420107 5398192 442381 5412352
    CONNECTIONTYPE postgis
    PROCESSING "CLOSE_CONNECTION=DEFER" # For performance
    CONNECTION "${mapserver_connection}"
    DATA "geom FROM (SELECT geo.geom as geom, gid, class FROM geodata.planville AS geo) AS foo USING UNIQUE gid USING srid=900913"
    
    PROJECTION
      "init=epsg:3857"
    END
    MAXSCALEDENOM 14999
    CLASSITEM "class"
    CLASS   
        EXPRESSION "VOIE"
        STYLE
          COLOR 255 255 255
          WIDTH 0.3
          OUTLINECOLOR -1 -1 -1
        END
    END
     CLASS
        EXPRESSION "PIET"
        STYLE
          WIDTH 1
          OUTLINECOLOR 100 100 100
          COLOR 220 220 220
        END
    END
    CLASS
        EXPRESSION "CYCL"
        STYLE
          WIDTH 1
          OUTLINECOLOR 100 100 100
          COLOR 100 100 100
        END
    END 
    CLASS
        EXPRESSION "AUTR"
        STYLE
          WIDTH 1
          OUTLINECOLOR 100 100 100
          COLOR 0 0 200
        END
    END
    CLASS
        EXPRESSION "AUTJ"
        STYLE
          WIDTH 1
          OUTLINECOLOR 100 100 100
          COLOR 0 200 0
        END
    END 
    CLASS
        EXPRESSION "ILOT"
        STYLE
          WIDTH 1
          OUTLINECOLOR 100 100 100
          COLOR 220 220 220
        END 
    END 
    
    METADATA
        "wms_title" "Fond de plan Montpellier" # For WMS
        "wms_srs" "epsg:3857" # For WMS
        
        "wms_metadataurl_href" "http://opendata.montpelliernumerique.fr/Planville" # For metadata URL
        "wms_metadataurl_format" "text/html" # For metadata URL
        "wms_metadataurl_type" "TC211" # For metadata URL
    
    END
  END 
  
LAYER
    NAME 'mtp_sous_quartiers_label'
    GROUP plan
    TYPE POLYGON
    STATUS ON
    TEMPLATE fooOnlyForWMSGetFeatureInfo # For GetFeatureInfo
    EXTENT 420107 5398192 442381 5412352
    CONNECTIONTYPE postgis
    PROCESSING "CLOSE_CONNECTION=DEFER" # For performance
    CONNECTION "${mapserver_connection}"
    #DATA "geom FROM (SELECT geo.geom as geom, libsquart, libquart, gid FROM geodata.sous_quartiers AS geo, ${mapserver_join_tables} WHERE ST_Contains(${mapserver_join_area}, geo.geom) AND ${mapserver_join_where} 'sous_quartiers') AS foo USING UNIQUE gid USING srid=900913"
    DATA "geom FROM (SELECT geo.geom as geom, libsquart, libquart, gid FROM geodata.sous_quartiers AS geo) AS foo USING UNIQUE gid USING srid=900913"
    PROJECTION
      "init=epsg:3857"
    END
    LABELITEM "libsquart"
    MAXSCALEDENOM 39999
    MINSCALEDENOM 15000
    CLASS
        STYLE
          COLOR 200 200 200
          OUTLINECOLOR 0 0 0
        END
        LABEL
          COLOR  50 50 50
          OUTLINECOLOR 255 255 255
          FONT "arial"
          TYPE truetype
          SIZE 8
          POSITION cc
          PARTIALS FALSE
          MAXSCALEDENOM 39999
          MINSCALEDENOM 15000
        END
    END
    METADATA
        "wms_title" "Sous-quartiers" # For WMS
        "wms_srs" "epsg:3857" # For WMS

        "gml_include_items" ""  # For GetFeatureInfo and WFS GetFeature (QuerryBuilder)
        "ows_geom_type" "polygon" # For returning geometries in GetFeatureInfo
        "ows_geometries" "geom" # For returning geometries in GetFeatureInfo

        "wms_metadataurl_href" "http://opendata.montpelliernumerique.fr/Sous-quartiers" # For metadata URL
        "wms_metadataurl_format" "text/html" # For metadata URL
        "wms_metadataurl_type" "TC211" # For metadata URL
    END
END

LAYER
    NAME 'mtp_quartiers_label'
    GROUP plan
    TYPE POLYGON
    STATUS ON
    TEMPLATE fooOnlyForWMSGetFeatureInfo # For GetFeatureInfo
    EXTENT 420107 5398192 442381 5412352
    CONNECTIONTYPE postgis
    PROCESSING "CLOSE_CONNECTION=DEFER" # For performance
    CONNECTION "${mapserver_connection}"

    DATA "geom FROM (SELECT geo.geom as geom, libquart, gid FROM geodata.quartiers AS geo) AS foo USING UNIQUE gid USING srid=900913"

    PROJECTION
      "init=epsg:3857"
    END
    LABELITEM "libquart"
    MAXSCALEDENOM 150000
    MINSCALEDENOM 40000
    CLASS
        STYLE
           COLOR 150 150 150
           OUTLINECOLOR 0 0 0
        END
        LABEL
          COLOR  50 50 50
          OUTLINECOLOR 255 255 255
          FONT "arial"
          TYPE truetype
          SIZE 8
          POSITION cc
          PARTIALS FALSE
          MAXSCALEDENOM 150000
          MINSCALEDENOM 40000
        END
    END
    METADATA
        "wms_title" "Quartiers" # For WMS
        "wms_srs" "epsg:3857" # For WMS

        "gml_include_items" ""  # For GetFeatureInfo and WFS GetFeature (QuerryBuilder)
        "ows_geom_type" "polygon" # For returning geometries in GetFeatureInfo
        "ows_geometries" "geom" # For returning geometries in GetFeatureInfo

        "wms_metadataurl_href" "http://opendata.montpelliernumerique.fr/Quartiers" # For metadata URL
        "wms_metadataurl_format" "text/html" # For metadata URL
        "wms_metadataurl_type" "TC211" # For metadata URL

    END
END

#  LAYER
#    NAME "communes"
#    GROUP "plan"
#    STATUS ON
#    DATA
#  END

#  LAYER
#       NAME "ortho_world"  
#       GROUP "ortho"
#       #DEBUG 5
#       STATUS ON
#       TYPE RASTER
#       DATA /var/sig/demo/c2cgeoportal/Ortho/mapbox_900913.xml 
#       PROCESSING "OVERSAMPLE_RATIO=1"
#       PROCESSING "RESAMPLE=BILINEAR"
#       PROJECTION
#          "init=epsg:3857"
#       END
#       METADATA
#         "wms_title" "Ortho mondial mapbox" # For WMS
#         "wms_group_title" "ortho"
#         "wms_srs" "epsg:3857" # For WMS
#       END
#
#  END

  LAYER
        NAME "ortho_world_bluemarble"
        GROUP "ortho"
        #DEBUG 5
        STATUS ON
        TYPE RASTER
        TILEINDEX /var/sig/demo/c2cgeoportal/Ortho/bm/tindex.shp
        #DATA /var/sig/demo/c2cgeoportal/Ortho/world.topo.bathy.200407.3x21600x21600.D2.tiff
        PROCESSING "OVERSAMPLE_RATIO=1"
        PROCESSING "RESAMPLE=BILINEAR"
        PROJECTION
           "init=epsg:4326"
        END
        METADATA
          "wms_title" "Ortho Blue Marble Next Generation NASA" # For WMS
          "wms_group_title" "ortho"
          "wms_srs" "epsg:3857" # For WMS
        END
   END

   LAYER
       NAME 'ortho_montpellier'
       GROUP 'ortho'
       TYPE RASTER
       #DEBUG 5
       PROJECTION
         "init=epsg:2154"
       END
       STATUS ON
       DATA /var/sig/demo/c2cgeoportal/Ortho/VilleMTP_MTP_OrthoPhoto_2011.ecw
       PROCESSING "RESAMPLE=AVERAGE"
       METADATA
         "wms_title" "Ortho montpellier" # For WMS
         "wms_group_title" "ortho"
         "wms_srs" "epsg:3857" # For WMS
       END
  END


END
